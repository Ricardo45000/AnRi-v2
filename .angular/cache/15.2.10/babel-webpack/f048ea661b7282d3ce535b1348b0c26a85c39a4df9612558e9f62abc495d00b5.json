{"ast":null,"code":"import _asyncToGenerator from \"/Users/ricardoda-silva/Desktop/Project/RiAn/AnRi v2/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { createMachine, sendUpdate } from 'xstate';\nimport { fetchUserAttributes, resetPassword, resendSignUpCode, confirmSignIn, signInWithRedirect } from 'aws-amplify/auth';\nimport { runValidators } from '../../../validators/index.mjs';\nimport ACTIONS from '../actions.mjs';\nimport { defaultServices } from '../defaultServices.mjs';\nimport GUARDS from '../guards.mjs';\nimport { getFederatedSignInState } from './utils.mjs';\nconst handleSignInResponse = {\n  onDone: [{\n    cond: 'hasCompletedSignIn',\n    actions: 'setNextSignInStep',\n    target: '#signInActor.fetchUserAttributes'\n  }, {\n    cond: 'shouldConfirmSignInWithNewPassword',\n    actions: ['setMissingAttributes', 'setNextSignInStep'],\n    target: '#signInActor.forceChangePassword'\n  }, {\n    cond: 'shouldResetPasswordFromSignIn',\n    actions: 'setNextSignInStep',\n    target: '#signInActor.resetPassword'\n  }, {\n    cond: 'shouldConfirmSignUpFromSignIn',\n    actions: 'setNextSignInStep',\n    target: '#signInActor.resendSignUpCode'\n  }, {\n    actions: ['setChallengeName', 'setMissingAttributes', 'setNextSignInStep', 'setTotpSecretCode'],\n    target: '#signInActor.init'\n  }],\n  onError: {\n    actions: 'setRemoteError',\n    target: 'edit'\n  }\n};\nconst handleFetchUserAttributesResponse = {\n  onDone: [{\n    cond: 'shouldVerifyAttribute',\n    actions: ['setShouldVerifyUserAttributeStep', 'setUnverifiedUserAttributes'],\n    target: '#signInActor.resolved'\n  }, {\n    actions: 'setConfirmAttributeCompleteStep',\n    target: '#signInActor.resolved'\n  }],\n  onError: {\n    actions: 'setConfirmAttributeCompleteStep',\n    target: '#signInActor.resolved'\n  }\n};\nfunction signInActor({\n  services\n}) {\n  return createMachine({\n    id: 'signInActor',\n    initial: 'init',\n    predictableActionArguments: true,\n    states: {\n      init: {\n        always: [{\n          cond: 'shouldConfirmSignIn',\n          target: 'confirmSignIn'\n        }, {\n          cond: 'shouldSetupTotp',\n          target: 'setupTotp'\n        }, {\n          cond: ({\n            step\n          }) => step === 'CONFIRM_SIGN_IN_WITH_NEW_PASSWORD_REQUIRED',\n          actions: 'setActorDoneData',\n          target: 'forceChangePassword'\n        }, {\n          target: 'signIn'\n        }]\n      },\n      federatedSignIn: getFederatedSignInState('signIn'),\n      fetchUserAttributes: {\n        invoke: {\n          src: 'fetchUserAttributes',\n          ...handleFetchUserAttributesResponse\n        }\n      },\n      resendSignUpCode: {\n        invoke: {\n          src: 'handleResendSignUpCode',\n          onDone: {\n            actions: 'setCodeDeliveryDetails',\n            target: '#signInActor.resolved'\n          },\n          onError: {\n            actions: 'setRemoteError',\n            target: '#signInActor.signIn'\n          }\n        }\n      },\n      resetPassword: {\n        invoke: {\n          src: 'resetPassword',\n          onDone: [{\n            actions: 'setCodeDeliveryDetails',\n            target: '#signInActor.resolved'\n          }],\n          onError: {\n            actions: ['setRemoteError', 'sendUpdate']\n          }\n        }\n      },\n      signIn: {\n        initial: 'edit',\n        exit: 'clearTouched',\n        states: {\n          edit: {\n            entry: 'sendUpdate',\n            on: {\n              CHANGE: {\n                actions: 'handleInput'\n              },\n              FEDERATED_SIGN_IN: {\n                target: '#signInActor.federatedSignIn'\n              },\n              SUBMIT: {\n                actions: 'handleSubmit',\n                target: 'submit'\n              }\n            }\n          },\n          submit: {\n            tags: 'pending',\n            entry: ['clearError', 'sendUpdate', 'setUsernameSignIn'],\n            exit: 'clearFormValues',\n            invoke: {\n              src: 'handleSignIn',\n              ...handleSignInResponse\n            }\n          }\n        }\n      },\n      confirmSignIn: {\n        initial: 'edit',\n        exit: ['clearChallengeName', 'clearFormValues', 'clearError', 'clearTouched'],\n        states: {\n          edit: {\n            entry: 'sendUpdate',\n            on: {\n              SUBMIT: {\n                actions: 'handleSubmit',\n                target: 'submit'\n              },\n              SIGN_IN: '#signInActor.signIn',\n              CHANGE: {\n                actions: 'handleInput'\n              }\n            }\n          },\n          submit: {\n            tags: 'pending',\n            entry: ['clearError', 'sendUpdate'],\n            invoke: {\n              src: 'confirmSignIn',\n              ...handleSignInResponse\n            }\n          }\n        }\n      },\n      forceChangePassword: {\n        entry: 'sendUpdate',\n        type: 'parallel',\n        exit: ['clearFormValues', 'clearError', 'clearTouched'],\n        states: {\n          validation: {\n            initial: 'pending',\n            states: {\n              pending: {\n                invoke: {\n                  src: 'validateFields',\n                  onDone: {\n                    target: 'valid',\n                    actions: 'clearValidationError'\n                  },\n                  onError: {\n                    target: 'invalid',\n                    actions: 'setFieldErrors'\n                  }\n                }\n              },\n              valid: {\n                entry: 'sendUpdate'\n              },\n              invalid: {\n                entry: 'sendUpdate'\n              }\n            },\n            on: {\n              SIGN_IN: {\n                actions: 'setSignInStep',\n                target: '#signInActor.resolved'\n              },\n              CHANGE: {\n                actions: 'handleInput',\n                target: '.pending'\n              },\n              BLUR: {\n                actions: 'handleBlur',\n                target: '.pending'\n              }\n            }\n          },\n          submit: {\n            initial: 'edit',\n            entry: 'clearError',\n            states: {\n              edit: {\n                entry: 'sendUpdate',\n                on: {\n                  SUBMIT: {\n                    actions: 'handleSubmit',\n                    target: 'validate'\n                  }\n                }\n              },\n              validate: {\n                entry: 'sendUpdate',\n                invoke: {\n                  src: 'validateFields',\n                  onDone: {\n                    actions: 'clearValidationError',\n                    target: 'pending'\n                  },\n                  onError: {\n                    actions: 'setFieldErrors',\n                    target: 'edit'\n                  }\n                }\n              },\n              pending: {\n                tags: 'pending',\n                entry: ['sendUpdate', 'clearError'],\n                invoke: {\n                  src: 'handleForceChangePassword',\n                  ...handleSignInResponse\n                }\n              }\n            }\n          }\n        }\n      },\n      setupTotp: {\n        initial: 'edit',\n        exit: ['clearFormValues', 'clearError', 'clearTouched'],\n        states: {\n          edit: {\n            entry: 'sendUpdate',\n            on: {\n              SUBMIT: {\n                actions: 'handleSubmit',\n                target: 'submit'\n              },\n              SIGN_IN: '#signInActor.signIn',\n              CHANGE: {\n                actions: 'handleInput'\n              }\n            }\n          },\n          submit: {\n            tags: 'pending',\n            entry: ['sendUpdate', 'clearError'],\n            invoke: {\n              src: 'confirmSignIn',\n              ...handleSignInResponse\n            }\n          }\n        }\n      },\n      resolved: {\n        type: 'final',\n        data: context => ({\n          codeDeliveryDetails: context.codeDeliveryDetails,\n          remoteError: context.remoteError,\n          step: context.step,\n          unverifiedUserAttributes: context.unverifiedUserAttributes,\n          username: context.username\n        })\n      }\n    }\n  }, {\n    // sendUpdate is a HOC\n    actions: {\n      ...ACTIONS,\n      sendUpdate: sendUpdate()\n    },\n    guards: GUARDS,\n    services: {\n      fetchUserAttributes() {\n        return _asyncToGenerator(function* () {\n          return fetchUserAttributes();\n        })();\n      },\n      resetPassword({\n        username\n      }) {\n        return resetPassword({\n          username\n        });\n      },\n      handleResendSignUpCode({\n        username\n      }) {\n        return resendSignUpCode({\n          username\n        });\n      },\n      handleSignIn({\n        formValues,\n        username\n      }) {\n        const {\n          password\n        } = formValues;\n        return services.handleSignIn({\n          username,\n          password\n        });\n      },\n      confirmSignIn({\n        formValues\n      }) {\n        const {\n          confirmation_code: challengeResponse\n        } = formValues;\n        return services.handleConfirmSignIn({\n          challengeResponse\n        });\n      },\n      handleForceChangePassword({\n        formValues\n      }) {\n        return _asyncToGenerator(function* () {\n          let {\n            password: challengeResponse,\n            phone_number,\n            country_code,\n            // destructure and toss UI confirm_password field\n            // to prevent error from sending to confirmSignIn\n            confirm_password,\n            ...userAttributes\n          } = formValues;\n          let phoneNumberWithCountryCode;\n          if (phone_number) {\n            phoneNumberWithCountryCode = `${country_code}${phone_number}`.replace(/[^A-Z0-9+]/gi, '');\n            userAttributes = {\n              ...userAttributes,\n              phone_number: phoneNumberWithCountryCode\n            };\n          }\n          const input = {\n            challengeResponse,\n            options: {\n              userAttributes\n            }\n          };\n          return confirmSignIn(input);\n        })();\n      },\n      signInWithRedirect(_, {\n        data\n      }) {\n        return signInWithRedirect(data);\n      },\n      validateFields(context) {\n        return _asyncToGenerator(function* () {\n          return runValidators(context.formValues, context.touched, context.passwordSettings, [defaultServices.validateFormPassword, defaultServices.validateConfirmPassword]);\n        })();\n      }\n    }\n  });\n}\nexport { signInActor };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}